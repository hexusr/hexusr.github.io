---
layout: post
title:  "ls命令的简单实现"
date:   2017-10-09
categories: Linux-C
---
## 1. ls1.c代码如下：
```
#include <dirent.h>
#include <stdio.h>
#include <stdlib.h>
int main(int argc, char *argv[])
{
	DIR		*dp;
	struct dirent 	*dirp;
	if(argc !=2)
		printf("usage: ls directory_name");
	if((dp = opendir(argv[1]))== NULL)
		printf("can't open %s",argv[1]);
	while ((dirp = readdir(dp)) !=NULL)
		printf("%s\n",dirp->d_name);
	closedir(dp);
	exit(0);
}
```
## 2. dirent.h头文件介绍
<dirent.h>是类unix系统目录操作的头文件，包含了打开目录、读目录等等常用函数。
<dirent.h>位于/usr/include/ 和 /usr/include/bits/ 这2个目录下，
其中opendir 和readdir 2个函数在 /usr/include/dirent.h 中定义.
struct dirent 在 /usr/include/bits/dirent.h 中定义
## 3.相关源码
我就不翻译了O(∩_∩)O~
### 3.1 struct dirent 的定义 (/usr/include/bits/dirent.h)
```
struct dirent
  {
#ifndef __USE_FILE_OFFSET64
    __ino_t d_ino;
    __off_t d_off;
#else
    __ino64_t d_ino;
    __off64_t d_off;
#endif
    unsigned short int d_reclen;
    unsigned char d_type;
    char d_name[256];		/* We must not include limits.h! */
  };
```
/usr/include/bits/dirent.h 中提示永远不要是用这个目录下的dirent.h头文件替代/usr/include/dirent.h头文件。
### 3.2 DIR变量 (_dirstream结构体) 
```
/* This is the data type of directory stream objects.
   The actual structure is opaque to users.  */
typedef struct __dirstream DIR;
```
### 3.3 opendir函数
```
/* Open a directory stream on NAME.
   Return a DIR stream on the directory, or NULL if it could not be opened.

   This function is a possible cancellation point and therefore not
   marked with __THROW.  */
extern DIR *opendir (const char *__name) __nonnull ((1));
```

### 3.4 readdir函数
```
/* Read a directory entry from DIRP.  Return a pointer to a `struct
   dirent' describing the entry, or NULL for EOF or error.  The
   storage returned may be overwritten by a later readdir call on the
   same DIR stream.

   If the Large File Support API is selected we have to use the
   appropriate interface.

   This function is a possible cancellation point and therefore not
   marked with __THROW.  */
#ifndef __USE_FILE_OFFSET64
extern struct dirent *readdir (DIR *__dirp) __nonnull ((1));
```